name: Build Installer

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install NSIS
        shell: pwsh
        run: |
          choco install nsis -y
          $nsisPath = "${env:ProgramFiles(x86)}\NSIS"
          if (!(Test-Path $nsisPath)) { throw "NSIS not found at $nsisPath" }
          Add-Content $env:GITHUB_PATH $nsisPath

      - name: Build EXE with makensis
        shell: pwsh
        run: |
          $nsi = "IntelMipiCamera.nsi"
          if (!(Test-Path $nsi)) { throw "NSIS script not found: $nsi" }

          # Optional: verify makensis is now resolvable
          Get-Command makensis.exe | Format-List *

          makensis.exe /V4 $nsi

          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Get-ChildItem -Path . -Filter "*.exe" | ForEach-Object {
            Copy-Item $_.FullName -Destination (Join-Path "dist" $_.Name) -Force
          }

          Write-Host "Built artifacts:"
          Get-ChildItem dist | Format-Table -AutoSize

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: IntelMipiCamera-installer
          path: dist/*.exe

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: windows-latest

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: IntelMipiCamera-installer
          path: dist

      - name: Create GitHub Release + upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.exe
          generate_release_notes: true
